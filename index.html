<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Night City Datapad 2045</title>
    
    <!-- PWA & Mobile Meta Tags -->
    <meta name="theme-color" content="#0a0a0a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NC Datapad">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,400;0,700;1,800&display=swap');

        :root {
            --neon-red: #ff0000;
            --dark-bg: #0a0a0a;
            --zinc-900: #18181b;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: var(--dark-bg);
            color: #ef4444;
            overflow: hidden;
            overscroll-behavior-y: contain;
        }

        .scanlines {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(255, 0, 0, 0.03));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.1;
        }

        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-2px, 2px); }
            40% { transform: translate(-2px, -2px); }
            60% { transform: translate(2px, 2px); }
            80% { transform: translate(2px, -2px); }
            100% { transform: translate(0); }
        }

        .glitch-active {
            animation: glitch 0.2s infinite;
        }

        @keyframes subtle-vibe {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.1); }
            100% { filter: brightness(1); }
        }

        .is-talking {
            animation: subtle-vibe 0.1s infinite;
            filter: drop-shadow(0 0 5px rgba(255, 0, 0, 0.4));
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #dc2626; }

        .audio-bar {
            width: 4px;
            background-color: #dc2626;
            transition: height 0.1s ease;
        }

        .music-wave {
            display: flex;
            align-items: flex-end; gap: 1px; height: 10px;
        }
        .music-bar {
            width: 2px; background: #ef4444; height: 2px;
        }
        .music-bar.playing {
            animation: wave 0.6s infinite ease-in-out alternate;
        }
        @keyframes wave { from { height: 2px; } to { height: 10px; } }

        .safe-top { padding-top: env(safe-area-inset-top); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }

        .spinner {
            border: 2px solid rgba(239, 68, 68, 0.1);
            border-left-color: #ef4444;
            border-radius: 50%;
            width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .map-district {
            transition: all 0.2s ease;
            cursor: pointer;
            fill: rgba(255, 0, 0, 0.05);
            stroke: rgba(255, 0, 0, 0.3);
            stroke-width: 0.5;
        }
        .map-district:hover {
            fill: rgba(255, 0, 0, 0.2);
            stroke: rgba(255, 0, 0, 1);
            stroke-width: 1;
        }

        .static-marker {
            stroke: #ef4444;
            stroke-width: 1;
            fill: none;
        }
        .static-marker-center {
            fill: #ef4444;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-0 sm:p-4">

    <div class="scanlines"></div>
    <div class="fixed inset-0 opacity-10 pointer-events-none" 
         style="background-image: radial-gradient(#ff0000 1px, transparent 1px); background-size: 20px 20px;"></div>

    <audio id="bg-music" loop crossorigin="anonymous">
        <source src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme.mp3" type="audio/mpeg">
    </audio>

    <div id="datapad-frame" class="relative w-full max-w-2xl bg-zinc-900 border-x-0 sm:border-4 border-zinc-800 sm:rounded-xl overflow-hidden shadow-[0_0_50px_rgba(255,0,0,0.15)] flex flex-col h-screen sm:h-[90vh]">
        
        <!-- Status Bar -->
        <div class="bg-zinc-800 p-2 safe-top flex justify-between items-center text-[10px] border-b border-red-900/50 z-20">
            <div class="flex items-center gap-4">
                <span class="flex items-center gap-1 font-bold">
                    <i data-lucide="shield-alert" class="w-3 h-3 text-red-600 animate-pulse"></i>
                    SYSTEM: RED_OS_v4.5
                </span>
            </div>
            <div class="flex items-center gap-3">
                <button id="music-btn" onclick="toggleMusic()" class="flex items-center gap-2 bg-black/40 px-2 py-1 border border-zinc-700 hover:border-red-500 transition-colors">
                    <div class="music-wave" id="music-wave-ui">
                        <div class="music-bar"></div><div class="music-bar"></div><div class="music-bar"></div>
                    </div>
                    <i data-lucide="music" class="w-3 h-3"></i>
                </button>
                <i data-lucide="wifi" class="w-3 h-3"></i>
                <div class="flex items-center gap-1"><span>98%</span><i data-lucide="battery" class="w-3 h-3"></i></div>
            </div>
        </div>

        <div id="screen-content" class="flex-1 relative p-6 overflow-y-auto custom-scrollbar bg-black/40 z-10 flex flex-col">
            
            <div id="lock-screen" class="flex flex-col items-center justify-center h-full flex-1 py-20 text-center">
                <i data-lucide="lock" class="w-12 h-12 mb-4 text-red-600"></i>
                <h2 class="text-xl font-bold mb-2 uppercase italic tracking-widest">Verschlüsselt</h2>
                <button onclick="decryptSystem()" class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-none border border-red-400 font-bold tracking-widest transition-all active:scale-95 shadow-lg">
                    INITIALISIEREN
                </button>
            </div>

            <!-- HOME -->
            <div id="tab-home" class="hidden flex-col space-y-6 flex-1">
                <div class="border-l-4 border-red-600 pl-4 py-2 bg-red-950/20">
                    <h1 class="text-2xl sm:text-3xl font-black italic uppercase leading-none tracking-tighter text-red-500">SYSTEM // BRIEFING 2045</h1>
                    <p class="text-[10px] text-zinc-400 mt-2 uppercase tracking-widest">Status: Dekomprimiert | Subjekt: Night City</p>
                </div>
                
                <div class="space-y-6 text-sm sm:text-base leading-relaxed text-red-400/90 text-justify">
                    <section>
                        <h2 class="text-white uppercase font-black tracking-wider border-b border-red-900/50 mb-2">> DIE ZEIT DES ROTS</h2>
                        <p>Wir schreiben das Jahr 2045. Die Welt erholt sich langsam vom Vierten Konzernkrieg. Der Himmel über Night City glüht oft in einem bedrohlichen Rot. Die alte Weltordnung ist zerbrochen. Wer überleben will, muss sich anpassen – oder genug Chrome besitzen.</p>
                    </section>

                    <section class="bg-zinc-900 border border-zinc-700 p-4 text-[11px] sm:text-sm space-y-3 shadow-inner">
                        <p class="text-white uppercase font-black tracking-widest border-b border-zinc-700 pb-2 mb-2">>> TREFFPUNKT-PROTOKOLL_</p>
                        <div class="grid grid-cols-1 gap-2">
                            <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Ort:</span> „El Coyote Rojo" (VIP-Bereich)</p>
                            <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Zeit:</span> 22:00 Uhr // Morgen</p>
                            <p><span class="text-zinc-500 w-24 inline-block uppercase font-bold text-[10px]">Codewort:</span> <span class="text-white italic">"Grey schickt mich."</span></p>
                        </div>
                    </section>
                </div>

                <div class="bg-red-600/20 border border-red-500 p-4 font-bold italic shadow-lg text-sm sm:text-base text-center mt-auto">
                    <p class="text-white uppercase tracking-widest">Kommt bewaffnet. Kommt nicht zu spät.</p>
                </div>
            </div>

            <!-- COMMS -->
            <div id="tab-comms" class="hidden flex-col space-y-4 flex-1">
                <div class="relative aspect-video w-full bg-black border-2 border-zinc-800 rounded overflow-hidden flex items-center justify-center">
                    <div id="image-loader" class="flex flex-col items-center gap-3 text-red-500 z-10">
                        <div class="spinner"></div>
                        <span class="text-[10px] animate-pulse uppercase tracking-widest font-bold">Signal-Aufbau...</span>
                    </div>
                    <div id="grey-feed-container" class="hidden absolute inset-0">
                        <img id="grey-image" src="" alt="Mr. Grey" class="w-full h-full object-cover grayscale opacity-70 transition-all brightness-75">
                        <div class="absolute inset-0 bg-red-900/10 mix-blend-overlay"></div>
                    </div>
                </div>

                <div class="bg-zinc-900/80 border border-zinc-800 p-4 shadow-xl">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <button id="voice-play-btn" onclick="playVoice()" class="p-4 bg-red-600 rounded-full text-white hover:bg-red-500 shadow-[0_0_15px_rgba(255,0,0,0.4)] transition-all active:scale-90">
                                <i id="play-btn-icon" data-lucide="play" class="w-6 h-6 fill-current"></i>
                            </button>
                            <button onclick="stopVoice()" class="p-3 bg-zinc-800 border border-zinc-700 rounded-full text-zinc-400 hover:text-white transition-all active:scale-90">
                                <i data-lucide="square" class="w-4 h-4 fill-current"></i>
                            </button>
                            <div class="flex flex-col">
                                <p class="text-xs font-bold text-red-500 uppercase">Crypt-Vox Feed</p>
                                <p class="text-[8px] text-zinc-500 font-mono">ID: GREY_SECURE_V4</p>
                            </div>
                        </div>
                        <div id="visualizer" class="flex gap-1 h-8 items-end">
                            <div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div><div class="audio-bar h-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MAP -->
            <div id="tab-map" class="hidden flex-col h-full flex-1">
                <div class="relative w-full flex-1 min-h-[400px] bg-zinc-950 border border-zinc-800 rounded overflow-hidden shadow-inner flex items-center justify-center">
                    <div id="map-loader" class="flex flex-col items-center gap-3 text-red-500 z-10">
                        <div class="spinner"></div>
                    </div>
                    <div id="city-map-container" class="hidden absolute inset-0">
                        <img id="city-map-img" src="" alt="Night City Map" class="w-full h-full object-cover opacity-60 grayscale brightness-50">
                        <div class="absolute inset-0 bg-red-900/5 mix-blend-color"></div>
                        <svg viewBox="0 0 100 120" class="absolute inset-0 w-full h-full z-10" preserveAspectRatio="none">
                            <path d="M 30 5 L 70 5 L 80 30 L 60 40 L 25 35 Z" class="map-district" onclick="showDistrictInfo('Watson', 'INDUSTRIE', 'Ehemaliges Arasaka-Zentrum.')"/>
                            <path d="M 70 5 L 95 20 L 90 60 L 70 55 L 80 30 Z" class="map-district" onclick="showDistrictInfo('Westbrook', 'WOHLZUSTAND', 'Reiche Enklaven.')"/>
                            <path d="M 40 40 L 60 40 L 70 55 L 50 65 L 30 55 Z" class="map-district" onclick="showDistrictInfo('City Center', 'RADIOAKTIV', 'Ground Zero.')"/>
                            <path d="M 25 55 L 50 65 L 55 85 L 20 80 Z" class="map-district" onclick="showDistrictInfo('Heywood', 'ÜBERFÜLLT', 'Heimat des Coyote Rojo.')"/>
                            <g class="animate-pulse"><circle cx="45" cy="75" r="1.5" fill="#ef4444" /></g>
                        </svg>
                    </div>
                    <div id="map-info" class="absolute bottom-4 left-4 right-4 bg-black/90 border border-red-900/50 p-3 text-[10px] backdrop-blur-md text-center text-zinc-500 uppercase tracking-widest font-bold z-20">Wähle Sektor...</div>
                </div>
            </div>

            <!-- LOC -->
            <div id="tab-location" class="hidden flex-col space-y-4 flex-1">
                <div class="relative aspect-square w-full bg-[#050505] border-2 border-zinc-800 rounded overflow-hidden flex items-center justify-center">
                    <div id="loc-loader" class="flex flex-col items-center gap-3 text-red-500 z-10">
                        <div class="spinner"></div>
                    </div>
                    <div id="loc-image-container" class="hidden absolute inset-0">
                        <img id="loc-image" src="" alt="Tactical Blueprint" class="w-full h-full object-cover opacity-20 grayscale brightness-50">
                        <div class="absolute inset-0 bg-red-950/20 mix-blend-color"></div>

                        <svg viewBox="0 0 200 200" class="absolute inset-0 w-full h-full z-10" preserveAspectRatio="xMidYMid meet">
                            <defs>
                                <pattern id="tactical-grid-final" width="20" height="20" patternUnits="userSpaceOnUse">
                                    <path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(239, 68, 68, 0.1)" stroke-width="0.5"/>
                                </pattern>
                            </defs>
                            <rect width="100%" height="100%" fill="url(#tactical-grid-final)" />
                            <path d="M 20 60 L 120 60 L 120 180 L 20 180 Z" fill="none" stroke="rgba(239, 68, 68, 0.6)" stroke-width="1.5" />
                            <rect x="30" y="80" width="15" height="60" fill="rgba(239, 68, 68, 0.15)" stroke="#ef4444" stroke-width="0.8" />
                            <circle cx="70" cy="110" r="6" fill="none" stroke="rgba(239, 68, 68, 0.3)" stroke-width="0.5" />
                            <circle cx="100" cy="110" r="6" fill="none" stroke="rgba(239, 68, 68, 0.3)" stroke-width="0.5" />
                            <line x1="60" y1="180" x2="80" y2="180" stroke="#ef4444" stroke-width="3" />
                            <path d="M 120 60 L 180 60 L 180 130 L 120 130 Z" fill="rgba(239, 68, 68, 0.05)" stroke="#ef4444" stroke-width="1.5" />
                            <g transform="translate(150, 100)">
                                <circle r="8" class="static-marker" />
                                <circle r="1" class="static-marker-center" />
                                <line x1="0" y1="-12" x2="0" y2="-6" class="static-marker" />
                                <line x1="0" y1="6" x2="0" y2="12" class="static-marker" />
                                <line x1="-12" y1="0" x2="-6" y2="0" class="static-marker" />
                                <line x1="6" y1="0" x2="12" y2="0" class="static-marker" />
                                <text x="12" y="4" fill="#ef4444" font-size="7" font-weight="black" class="uppercase">MR. GREY</text>
                            </g>
                        </svg>
                    </div>
                </div>
                
                <div class="bg-zinc-900 border border-zinc-700 p-3 text-[9px] uppercase space-y-1 shadow-md">
                    <p class="text-white font-bold tracking-widest border-b border-zinc-800 pb-1 mb-1">> ANALYSE-PROTOKOLL:</p>
                    <div class="flex justify-between"><span>Sektor:</span><span class="text-red-400 font-bold uppercase">VIP_ZONE [Statisch]</span></div>
                </div>
            </div>

            <!-- APP -->
            <div id="tab-app" class="hidden flex-col items-center justify-center h-full flex-1 space-y-4 text-center">
                <div class="bg-white p-4 rounded-sm shadow-xl"><div id="qr-code-img"></div></div>
                <p class="text-[8px] text-zinc-600 px-10 italic uppercase" id="url-display"></p>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div id="nav-bar" class="hidden bg-zinc-800 flex border-t border-zinc-700 z-20 overflow-x-auto safe-bottom">
            <button onclick="switchTab('home')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center bg-red-600 text-white min-w-[70px]"><i data-lucide="home" class="w-4 h-4"></i> Home</button>
            <button onclick="switchTab('comms')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="radio" class="w-4 h-4"></i> Comms</button>
            <button onclick="switchTab('map')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="map-pin" class="w-4 h-4"></i> Map</button>
            <button onclick="switchTab('location')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="layout" class="w-4 h-4"></i> LOC</button>
            <button onclick="switchTab('app')" class="nav-btn flex-1 py-4 text-[9px] font-black uppercase transition-all flex flex-col items-center text-zinc-500 min-w-[70px]"><i data-lucide="smartphone" class="w-4 h-4"></i> APP</button>
        </div>
    </div>

    <script>
        // HIER DEINEN API KEY EINTRAGEN FÜR GITHUB PAGES
        const apiKey = "AIzaSyBXp_SHN8z141maVuzsRN2zms2FZ_M5AOo";

        let isDecrypted = false, currentAudio = null, isPlayingVoice = false, cachedVoiceBlobUrl = null;

        if (typeof lucide !== 'undefined') lucide.createIcons();

        async function preloadVoice() {
            if (!apiKey) return;
            const msg = "Choombas, willkommen in Night City. Ich bin Mr. Grey. Ihr wollt Arbeit? Dann kommt zum El Coyote Rojo. Heywood. Kommt bewaffnet, kommt stylisch. Aber kommt nicht zu spät. Style over Substance, Choom.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Say in an extremely raspy, deep, cigarette-burnt human voice, sounding exhausted and gravelly. Deep human voice, no robot: ${msg}` }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"], 
                            speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Iapetus" } } } 
                        }
                    })
                });
                const result = await response.json();
                const b64Audio = result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (b64Audio) {
                    const binaryString = atob(b64Audio);
                    const bytes = new Int16Array(binaryString.length / 2);
                    for (let i = 0; i < binaryString.length; i += 2) bytes[i / 2] = (binaryString.charCodeAt(i + 1) << 8) | binaryString.charCodeAt(i);
                    const wavBlob = createWav(bytes, 24000);
                    cachedVoiceBlobUrl = URL.createObjectURL(wavBlob);
                }
            } catch (e) {}
        }

        async function generateImages() {
            const fallbacks = {
                grey: "https://images.unsplash.com/photo-1605806616949-1e87b487cb2a?q=80&w=1200&auto=format&fit=crop",
                map: "https://images.unsplash.com/photo-1449156003053-c3042196ac20?q=80&w=1200&auto=format&fit=crop",
                loc: "https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1200&auto=format&fit=crop"
            };

            const revealImages = () => {
                document.querySelectorAll('.spinner').forEach(s => s.parentElement.classList.add('hidden'));
                document.getElementById('grey-feed-container').classList.remove('hidden');
                document.getElementById('city-map-container').classList.remove('hidden');
                document.getElementById('loc-image-container').classList.remove('hidden');
            };

            if (!apiKey) {
                document.getElementById('grey-image').src = fallbacks.grey;
                document.getElementById('city-map-img').src = fallbacks.map;
                document.getElementById('loc-image').src = fallbacks.loc;
                revealImages();
                return;
            }

            try {
                const fetchImg = (p) => fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instances: { prompt: p }, parameters: { sampleCount: 1 } })
                }).then(r => r.json());

                const [dGrey, dLoc, dMap] = await Promise.all([
                    fetchImg("Hyper-detailed cyberpunk noir portrait of Mr. Grey, legendary Night City fixer, glowing gray optic implants, chrome facial plating."),
                    fetchImg("Tactical architectural blueprint view of a dark cyberpunk bar, top down, red lighting accents."),
                    fetchImg("Tactical satellite map of Night City 2045, glowing red grid, districts outlined.")
                ]);

                document.getElementById('grey-image').src = dGrey.predictions?.[0] ? `data:image/png;base64,${dGrey.predictions[0].bytesBase64Encoded}` : fallbacks.grey;
                document.getElementById('loc-image').src = dLoc.predictions?.[0] ? `data:image/png;base64,${dLoc.predictions[0].bytesBase64Encoded}` : fallbacks.loc;
                document.getElementById('city-map-img').src = dMap.predictions?.[0] ? `data:image/png;base64,${dMap.predictions[0].bytesBase64Encoded}` : fallbacks.map;
                
                revealImages();
            } catch (e) {
                document.getElementById('grey-image').src = fallbacks.grey;
                document.getElementById('city-map-img').src = fallbacks.map;
                document.getElementById('loc-image').src = fallbacks.loc;
                revealImages();
            }
        }

        async function decryptSystem() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (ctx.state === 'suspended') ctx.resume();
            document.getElementById('datapad-frame').classList.add('glitch-active');
            generateImages();
            preloadVoice();
            setTimeout(() => {
                document.getElementById('lock-screen').classList.add('hidden');
                document.getElementById('tab-home').classList.remove('hidden');
                document.getElementById('tab-home').classList.add('flex');
                document.getElementById('nav-bar').classList.remove('hidden');
                document.getElementById('datapad-frame').classList.remove('glitch-active');
                isDecrypted = true;
                generateQRCode();
            }, 800);
        }

        function switchTab(tabId) {
            ['home', 'comms', 'map', 'location', 'app'].forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if(el) { el.classList.add('hidden'); el.classList.remove('flex'); }
            });
            const activeTab = document.getElementById(`tab-${tabId}`);
            if(activeTab) { activeTab.classList.remove('hidden'); activeTab.classList.add('flex'); }
            document.querySelectorAll('.nav-btn').forEach(btn => { 
                btn.classList.remove('bg-red-600', 'text-white'); btn.classList.add('text-zinc-500'); 
            });
            event.currentTarget.classList.add('bg-red-600', 'text-white');
            event.currentTarget.classList.remove('text-zinc-500');
        }

        function showDistrictInfo(name, status, desc) {
            document.getElementById('map-info').innerHTML = `<p class="text-red-500 font-bold uppercase">${name} [${status}]</p><p class="text-white mt-1 text-[8px] uppercase tracking-tighter">${desc}</p>`;
        }

        function stopVoice() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            isPlayingVoice = false;
            document.getElementById('grey-image').classList.remove('is-talking');
            document.querySelectorAll('.audio-bar').forEach(b => b.style.height = '4px');
        }

        async function playVoice() {
            if (isPlayingVoice || !cachedVoiceBlobUrl) return;
            isPlayingVoice = true;
            const bars = document.querySelectorAll('.audio-bar');
            const visInt = setInterval(() => {
                if(!isPlayingVoice) { clearInterval(visInt); return; }
                bars.forEach(b => b.style.height = `${Math.random()*28+4}px`);
            }, 80);
            currentAudio = new Audio(cachedVoiceBlobUrl);
            document.getElementById('grey-image').classList.add('is-talking');
            currentAudio.onended = () => stopVoice();
            currentAudio.play();
        }

        function createWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length * 2);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i = 0; i < s.length; i++) view.setUint8(o + i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 32 + pcmData.length * 2, true); writeString(8, 'WAVE'); writeString(12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, pcmData.length * 2, true); let offset = 44;
            for (let i = 0; i < pcmData.length; i++, offset += 2) view.setInt16(offset, pcmData[i], true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        function toggleMusic() {
            if (!isDecrypted) return;
            const bgMusic = document.getElementById('bg-music');
            const bars = document.querySelectorAll('#music-wave-ui .music-bar');
            if (bgMusic.paused) {
                bgMusic.play().then(() => bars.forEach(b => b.classList.add('playing'))).catch(e => console.log("Blocked"));
            } else {
                bgMusic.pause();
                bars.forEach(b => b.classList.remove('playing'));
            }
        }

        function generateQRCode() {
            const url = window.location.href;
            document.getElementById('url-display').innerText = url;
            if (!url.startsWith('file://')) {
                document.getElementById('qr-code-img').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" class="w-40 h-40">`;
            } else {
                document.getElementById('qr-code-img').innerHTML = "<p class='text-[10px] text-zinc-500 uppercase'>QR-Code nur online verfügbar</p>";
            }
        }
    </script>
</body>
</html>
